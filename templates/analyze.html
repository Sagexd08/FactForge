{% extends "base.html" %}

{% block title %}Analyze News - FactForge{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="text-center mb-4">
            <h1 class="display-5 fw-bold text-primary">
                <i class="fas fa-search me-3"></i>FactForge Analysis
            </h1>
            <p class="lead text-muted">Enter news text below to forge the truth - AI-powered authenticity detection</p>
        </div>

        {% if model_info %}
        <div class="alert alert-info text-center">
            <i class="fas fa-robot me-2"></i>
            <strong>Active Model:</strong> {{ model_info.model_name }} |
            <strong>Accuracy:</strong> {{ "%.1f"|format(model_info.performance_metrics.accuracy * 100) }}% |
            <strong>F1-Score:</strong> {{ "%.3f"|format(model_info.performance_metrics.f1_score) }}
        </div>
        {% endif %}

        <div class="card">
            <div class="card-body">
                <form id="predictionForm">
                    <div class="mb-4">
                        <label for="text" class="form-label fw-bold">
                            <i class="fas fa-newspaper me-2"></i>News Article Text
                        </label>
                        <textarea class="form-control" id="text" name="text" rows="8"
                                 placeholder="Paste your news article text here for analysis..."
                                 required style="border-radius: 10px; border: 2px solid #e5e7eb;"></textarea>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Minimum 10 characters required. Longer texts provide better analysis.
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                Characters: <span id="charCount">0</span> |
                                Words: <span id="wordCount">0</span>
                            </small>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <span id="submitText">
                                <i class="fas fa-search me-2"></i>Analyze News Article
                            </span>
                            <span id="loadingSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                        </button>
                    </div>
                </form>

                <div id="result" style="display: none;"></div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-shield-alt text-success" style="font-size: 2rem;"></i>
                        <h6 class="mt-2">Real News Example</h6>
                        <small class="text-muted">Factual, verifiable information from reliable sources</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
                        <h6 class="mt-2">Fake News Example</h6>
                        <small class="text-muted">Misleading, false, or unverifiable claims</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Character and word counter
document.getElementById('text').addEventListener('input', function() {
    const text = this.value;
    document.getElementById('charCount').textContent = text.length;
    document.getElementById('wordCount').textContent = text.trim().split(/\s+/).filter(word => word.length > 0).length;
});

// Form submission
document.getElementById('predictionForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const submitText = document.getElementById('submitText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultDiv = document.getElementById('result');

    // Show loading state
    submitBtn.disabled = true;
    submitText.innerHTML = '<i class="fas fa-cog fa-spin me-2"></i>Analyzing...';
    loadingSpinner.style.display = 'inline-block';
    resultDiv.style.display = 'none';

    try {
        const formData = new FormData(e.target);
        const response = await fetch('/predict', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (response.ok) {
            displayResult(data);
        } else {
            displayError(data.error);
        }
    } catch (error) {
        displayError('Network error: ' + error.message);
    } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitText.innerHTML = '<i class="fas fa-search me-2"></i>Analyze News Article';
        loadingSpinner.style.display = 'none';
    }
});

function displayResult(data) {
    const resultDiv = document.getElementById('result');
    const isFake = data.prediction === 'FAKE';
    const confidence = data.confidence || 0.5;

    const confidenceColor = confidence > 0.8 ? 'success' : confidence > 0.6 ? 'warning' : 'danger';
    const predictionIcon = isFake ? 'fas fa-exclamation-triangle' : 'fas fa-check-circle';
    const predictionColor = isFake ? 'danger' : 'success';

    resultDiv.innerHTML = `
        <div class="prediction-result ${isFake ? 'fake-result' : 'real-result'} mt-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h3 class="mb-3">
                        <i class="${predictionIcon} text-${predictionColor} me-2"></i>
                        ${data.prediction}
                    </h3>
                    ${data.confidence ? `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span><strong>Confidence Score</strong></span>
                                <span><strong>${(confidence * 100).toFixed(1)}%</strong></span>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill bg-${predictionColor}"
                                     style="width: ${confidence * 100}%"></div>
                            </div>
                            <small class="text-muted mt-1">
                                Certainty Level: ${confidence > 0.8 ? 'Very High' : confidence > 0.6 ? 'High' : confidence > 0.5 ? 'Moderate' : 'Low'}
                            </small>
                        </div>
                    ` : ''}
                </div>
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6><i class="fas fa-chart-bar me-2"></i>Analysis Details</h6>
                            <small class="text-muted">
                                <strong>Original:</strong> ${data.word_count} words<br>
                                <strong>Processed:</strong> ${data.processed_word_count} words<br>
                                <strong>Reduction:</strong> ${(data.reduction_ratio * 100).toFixed(1)}%<br>
                                <strong>Analyzed:</strong> ${new Date(data.timestamp).toLocaleString()}
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-3 text-center">
                <button class="btn btn-outline-primary btn-sm me-2" onclick="window.location.href='/history'">
                    <i class="fas fa-history me-1"></i>View History
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="analyzeAnother()">
                    <i class="fas fa-plus me-1"></i>Analyze Another
                </button>
            </div>
        </div>
    `;
    resultDiv.style.display = 'block';
    resultDiv.scrollIntoView({ behavior: 'smooth' });
}

function displayError(error) {
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = `
        <div class="alert alert-danger mt-4">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>Error:</strong> ${error}
        </div>
    `;
    resultDiv.style.display = 'block';
}

function analyzeAnother() {
    document.getElementById('text').value = '';
    document.getElementById('charCount').textContent = '0';
    document.getElementById('wordCount').textContent = '0';
    document.getElementById('result').style.display = 'none';
    document.getElementById('text').focus();
}
</script>
{% endblock %}